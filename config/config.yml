###############################################################################
# üì¶ Roboflow Inference + Motion Highlight + Tracker
# Optimiert f√ºr Larvenbewegung / Vibrationssieb
###############################################################################

app:
  name: roboflow-counter
  data_dir: /opt/larvacounter/export   # Export-Ordner f√ºr Debug Frames, Logs

# ---------------------------------------------------------------------------
# üé• Kamera-Input (RTSP/RTSPS)
# ---------------------------------------------------------------------------
input:
  # RTSP(S) Kamera Quelle (z. B. Unifi: rtsps://ip:7441/token?enableSrtp)
  rtsp_url: "rtsps://192.168.1.1:7441/ChVL5N4cBje3fRy7?enableSrtp"

# ---------------------------------------------------------------------------
# üì° Video Output (RTSP zu MediaMTX / VLC etc.)
# ---------------------------------------------------------------------------
output:
  # Highlight-Stream (nur Bewegungshervorhebung)
  rtsp_url: "rtsp://127.0.0.1:8554/larvacounter"

###############################################################################
# ‚ú® HIGHLIGHT OVERLAY SETTINGS
###############################################################################
background_darken: 0.40   # Abdunklungsfaktor (1.0 = kein Abdunkeln)

highlight:
  gain: 0.08              # Blendfaktor der Hervorhebung (0 = aus, 1 = stark)
  gauss:
    ksize: 21             # ungerade Zahl, gr√∂√üer = weicher
    sigma: "auto"         # "auto" = passend zur Kernelgr√∂√üe berechnet

###############################################################################
# üêõ MOTION DETECTION (EMA = Exponential Moving Average)
###############################################################################
motion:
  method: "ema"
  ema_alpha: 0.05        # kleiner = tr√§ger
  threshold: 0.5         # Bewegungsschwelle pro Pixel

###############################################################################
# üß´ REGION & GROWTH FILTER
###############################################################################
region:
  min_pixels: 100
  grow_iters: 2
  edge_threshold: 50
  gray_delta: 0

###############################################################################
# ‚öôÔ∏è RUNTIME SETTINGS
###############################################################################
runtime:
  fps: 5                  # 0 = Quelle √ºbernehmen
  open_timeout_ms: 8000   # Kameratimeout beim √ñffnen

###############################################################################
# üß† ROBOFLOW INFERENCE (lokal)
# - api_key wird aus .env via ${ROBOFLOW_API_KEY:-} aufgel√∂st
# - conf_thresh hier wirkt f√ºr inference.py (run_rtsp / _infer_once)
###############################################################################
inference:
  host: "http://127.0.0.1:9001"
  api_key: "${ROBOFLOW_API_KEY:-}"   # aus config/.env
  timeout_sec: 10
  jpeg_quality: 100
  max_fps: 3
  class_filter: []
  conf_thresh: 0.35
  # optionaler lokaler Cache f√ºr Model-/Dateidownloads durch inference.py
  cache_dir: "/home/manager/.cache/roboflow-counter"

###############################################################################
# üéØ TRACKER (Roboflow Inference + IoU-Matching + NVENC-Overlay)
# - nutzt Predictor ‚Üí versucht zuerst roboflow_counter.stream.inference (Model auto)
#   und f√§llt sonst auf HTTP (host oben) zur√ºck
###############################################################################
tracker:
  enabled: true

  # Quelle ist der Highlight-Stream
  source_rtsp: "rtsps://192.168.1.1:7441/ChVL5N4cBje3fRy7?enableSrtp"

  # Overlay-Output (mit Boxen/IDs) ‚Üí MediaMTX paths:* m√ºssen publishbar sein
  overlay_rtsp: "rtsp://127.0.0.1:8554/larvacounter_tracks"

  # Inference-Quelle (nur falls HTTP-Fallback n√∂tig)
  infer_host: "http://127.0.0.1:9001"

  # Modell (ohne Workspace-Prefix!)
  model_id: "dot_counting-plslb/35"

  # Key-Resolution aus .env (wird vom Code via _resolve_api_key sauber gezogen)
  api_key: "${ROBOFLOW_API_KEY:-}"

  # Detection/Tracking-Parameter
  class_filter: []        # nichts filtern
  conf_thresh: 0.05       # ggf. zum Testen 0.20 setzen
  iou_match_thresh: 0.5
  max_age: 20
  min_hits: 20
  target_fps: 9

  # Optional: Overlays als JPEG mit Rotation (f√ºr Debug)
  export:
    overlay_jpeg: false
    overlay_dir: "/home/manager/projects/roboflow-counter/export/tracker"
    overlay_every_n: 10

  # --------------------------------------------
  # üßÆ METRICS / Gl√§ttung & Stdout
  # --------------------------------------------
  metrics:
    # Metriken im Stdout des Trackers (JSON, alle X Sekunden)
    stdout_json: true
    interval_sec: 9      # Wie oft JSON-Metriken im Log ausgegeben werden
    smooth_sec: 9        # Fensterl√§nge in Sekunden f√ºr Median/Mean + HUD

###############################################################################
# ‚öñÔ∏è OHAUS WAAGE / PRINT-BRIDGE
# - konfiguriert die Ohaus-Integration (Waage ‚Üí Telegraf/Influx + Overlay + Anzeige-Pi)
###############################################################################
ohaus:
  # üîå Waage (TCP-Anschluss der Ohaus Ranger)
  scale_host: 10.10.150.215
  scale_port: 9761

  # üì° Telegraf socket_listener (siehe /etc/telegraf/telegraf.d/zzz_minimal.conf)
  telegraf_host: 127.0.0.1
  telegraf_port: 8094

  # üìä Tracker-Status (wird von tracker.py geschrieben, Tracks pro Frame/Fenster)
  tracker_status_json: "/home/manager/projects/roboflow-counter/export/tracker/status.json"

  # üé® Overlay-JSON f√ºr highlight.py (Gewicht, Tracks, Larven/g)
  overlay_json: "/home/manager/projects/roboflow-counter/export/ohaus_overlay.json"
  overlay_duration_sec: 20   # Sekunden, wie lange highlight.py das Overlay anzeigt
  db_delay_sec: 20   #Wert wir erst nach 20 Sekunden nanch dem Print Befehl in die datenbank geschrieben
  # üñ•Ô∏è Anzeige-Pi (zeigt 30s lang den Tracker-Stream, dann zur√ºck zu Grafana)
  display_pi_host: 10.10.150.252
  display_pi_user: "manager"
  display_pi_cmd: "sudo /usr/local/bin/show_tracker_30s.sh"

  # üì¨ Lokaler Trigger-Server f√ºr Remote-PRINT (nutzt bestehende Waagen-Verbindung)
  trigger_host: 127.0.0.1
  trigger_port: 9102

  # üßæ Influx-Measurement & Tags
  measurement: "ohaus_waage"
  tag_facility: "larvacounter"
  tag_host: "roboflow"
  ohaus_overlay_json: "/home/manager/projects/roboflow-counter/export/ohaus_overlay.json"  
  #  Zielwerte pro Batch und Teilgaben Larve  
  target_larvae_total: 110000   # Ziel: 110.000 Larven
  num_portions: 2               # z.B. 2 Teilgaben (Kippungen)
